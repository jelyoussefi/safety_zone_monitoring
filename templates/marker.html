{% extends "bootstrap/base.html" %}
{% import "bootstrap/wtf.html" as wtf %}

{% block title %}Safety Zone Monitor{% endblock %}

{% block head %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
{% endblock %}

{% block content %}
  <div class="container">
    <h1>Safety Zone Monitor</h1>
    <div class="button-panel">
      <button id="add-roi" class="btn btn-success">Add ROI</button>
      <button id="remove-roi" class="btn btn-danger">Remove</button>
      <button id="reset-rois" class="btn btn-warning">Reset</button>
      <button id="save-rois" class="btn btn-primary">Save</button>
      <a href="{{ url_for('home') }}" class="btn btn-info">Home</a>
    </div>
    <div id="video-container">
      <img id="video-feed" src="{{ url_for('video_feed') }}" alt="Video Feed">
      <canvas id="roi-canvas" width="1280" height="720"></canvas>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    const canvas = document.getElementById('roi-canvas');
    const ctx = canvas.getContext('2d');
    const videoFeed = document.getElementById('video-feed');
    let safetyRois = {{ config.safety_rois | default([]) | tojson | safe }};
    let drawing = false;
    let removing = false;
    let currentPoints = [];

    function resizeCanvas() {
      canvas.width = 1280;
      canvas.height = 720;
      drawROIs();
    }

    videoFeed.onload = resizeCanvas;
    videoFeed.onerror = function() {
      videoFeed.src = "{{ url_for('video_feed') }}?" + new Date().getTime();
    };
    window.addEventListener('resize', resizeCanvas);

    function pointInPolygon(point, polygon) {
      const x = point[0], y = point[1];
      let inside = false;
      for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
        const xi = polygon[i][0], yi = polygon[i][1];
        const xj = polygon[j][0], yj = polygon[j][1];
        const intersect = ((yi > y) !== (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
        if (intersect) inside = !inside;
      }
      return inside;
    }

    function drawROIs() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Draw saved ROIs (solid lines)
      safetyRois.forEach(roi => {
        const points = roi.coords;
        ctx.beginPath();
        ctx.moveTo(points[0][0], points[0][1]);
        for (let i = 1; i < points.length; i++) {
          ctx.lineTo(points[i][0], points[i][1]);
        }
        ctx.closePath();
        ctx.setLineDash([]); // Solid line for saved ROIs
        ctx.strokeStyle = 'red';
        ctx.lineWidth = 2;
        ctx.stroke();
        ctx.fillStyle = 'white';
        ctx.font = '14px Arial';
        ctx.fillText(roi.name, points[0][0] + 5, points[0][1] + 15);
      });

      // Draw current polygon being created
      if (drawing && currentPoints.length > 0) {
        ctx.strokeStyle = 'red';
        ctx.lineWidth = 2;
        if (currentPoints.length === 1) {
          // Draw a dot for the first point
          ctx.beginPath();
          ctx.arc(currentPoints[0][0], currentPoints[0][1], 3, 0, 2 * Math.PI);
          ctx.setLineDash([5, 5]); // Dashed style for visual indication
          ctx.fillStyle = 'red';
          ctx.fill();
          ctx.stroke();
        } else {
          // Draw lines for two or more points
          ctx.beginPath();
          ctx.moveTo(currentPoints[0][0], currentPoints[0][1]);
          for (let i = 1; i < currentPoints.length; i++) {
            ctx.lineTo(currentPoints[i][0], currentPoints[i][1]);
          }
          ctx.setLineDash([]); // Solid line for 2+ points
          ctx.stroke();
        }
      }
      ctx.setLineDash([]); // Reset to solid for next draw
    }

    canvas.addEventListener('click', (e) => {
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      if (drawing) {
        currentPoints.push([x, y]);
        drawROIs();
      } else if (removing) {
        // Check if click is inside any ROI
        for (let i = safetyRois.length - 1; i >= 0; i--) {
          const roi = safetyRois[i];
          if (pointInPolygon([x, y], roi.coords)) {
            safetyRois.splice(i, 1); // Remove the ROI
            drawROIs();
            break;
          }
        }
        removing = false; // Exit remove mode after one click
      }
    });

    canvas.addEventListener('dblclick', (e) => {
      if (drawing && currentPoints.length >= 3) {
        safetyRois.push({
          id: safetyRois.length + 1,
          name: `ROI ${safetyRois.length + 1}`,
          coords: currentPoints
        });
        currentPoints = [];
        drawing = false;
        drawROIs();
      }
    });

    document.getElementById('add-roi').addEventListener('click', () => {
      drawing = true;
      removing = false;
      currentPoints = [];
      drawROIs();
    });

    document.getElementById('remove-roi').addEventListener('click', () => {
      drawing = false;
      removing = true;
      currentPoints = [];
      drawROIs();
    });

    document.getElementById('reset-rois').addEventListener('click', () => {
      safetyRois = [];
      currentPoints = [];
      drawing = false;
      removing = false;
      drawROIs();
    });

    document.getElementById('save-rois').addEventListener('click', () => {
      fetch('/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ safety_rois: safetyRois })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('ROIs saved successfully!');
        } else {
          alert('Failed to save ROIs.');
        }
      })
      .catch(error => {
        console.error('Error saving ROIs:', error);
        alert('Error saving ROIs.');
      });
    });

    drawROIs();
  </script>
{% endblock %}